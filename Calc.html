<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>2:35 Monte Alto â€“ Calculadora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg-main: #f5f0e8;
      --bg-dark: #141417;
      --accent: #f4ff3b;
      --accent-soft: #ffe089;
      --text-main: #1b1b1f;
      --text-muted: #77757f;
      --pill-bg: #fff7e3;
      --danger: #ff4b4b;
      --radius-xl: 28px;
      --radius-lg: 20px;
      --shadow-soft: 0 16px 40px rgba(0, 0, 0, 0.16);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Roboto", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #fdf9f0 0, #e6decf 55%, #d4ccb9 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      color: var(--text-main);
    }

    body.dark {
      background: radial-gradient(circle at top, #222 0, #111 50%, #000 100%);
      color: #f6f5ff;
    }

    .app {
      width: 100%;
      max-width: 980px;
      margin: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-row {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (min-width: 840px) {
      .top-row {
        flex-direction: row;
      }
    }

    .card {
      background: rgba(255, 254, 250, 0.96);
      border-radius: var(--radius-xl);
      padding: 16px 18px 18px;
      box-shadow: var(--shadow-soft);
      position: relative;
    }

    body.dark .card {
      background: #18181f;
      color: #f6f5ff;
    }

    .card.hero {
      flex: 1.2;
    }

    .card.form-cart {
      flex: 1;
    }

    header.app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-name {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    .brand-sub {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    body.dark .brand-sub {
      color: #aaa7c5;
    }

    .mode-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      cursor: pointer;
      font-size: 11px;
    }

    body.dark .mode-toggle {
      background: rgba(255,255,255,0.06);
    }

    .mode-toggle span.icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    body.dark .mode-toggle span.icon {
      background: #111;
      color: #f4ff3b;
    }

    h1 {
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-bottom: 6px;
    }

    .hero-main-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .hero-subline {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    body.dark .hero-subline {
      color: #aaa7c5;
    }

    .hero-layout {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 16px;
      align-items: center;
    }

    @media (max-width: 720px) {
      .hero-layout {
        grid-template-columns: 1fr;
      }
    }

    .hero-image-wrap {
      display: flex;
      justify-content: center;
      position: relative;
    }

    .hero-plate {
      width: 260px;
      height: 170px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #f6e1c8 0, #d9a66b 60%, #b6793e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      overflow: hidden;
    }

    .hero-plate img {
      width: 115%;
      height: auto;
      object-fit: cover;
    }

    body.dark .hero-plate {
      background: radial-gradient(circle at top, #464049 0, #2f2530 60%, #1a1219 100%);
    }

    .hero-tag {
      position: absolute;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--pill-bg);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #6a4a1e;
      box-shadow: 0 6px 15px rgba(0,0,0,0.12);
    }

    body.dark .hero-tag {
      background: rgba(0,0,0,0.75);
      color: #ffe7b7;
    }

    .hero-tag span.icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #ffcf6f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .tag-left { left: 10px; top: 22px; }
    .tag-right { right: 10px; bottom: 10px; }

    .hero-text-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .hero-product-name {
      font-size: 20px;
      font-weight: 700;
    }

    .hero-price-line {
      font-size: 14px;
      font-weight: 600;
      color: #d88d17;
    }

    body.dark .hero-price-line {
      color: #ffd46a;
    }

    .hero-tagline {
      font-size: 13px;
      color: #4e4b54;
    }

    body.dark .hero-tagline {
      color: #cbc4de;
    }

    .hero-meta-row {
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      color: var(--text-muted);
    }

    body.dark .hero-meta-row {
      color: #a29dc0;
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.05);
    }

    body.dark .pill {
      background: rgba(255,255,255,0.08);
    }

    .stock-warning {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
    }

    .form-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .field-group {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 12px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #ddd2c3;
      font-size: 13px;
      font-family: var(--font-main);
      outline: none;
      background: #fffdf8;
    }

    textarea {
      min-height: 48px;
      resize: vertical;
    }

    body.dark input[type="text"],
    body.dark input[type="number"],
    body.dark select,
    body.dark textarea {
      background: #131319;
      border-color: #343440;
      color: #f6f5ff;
    }

    small.helper {
      font-size: 11px;
      color: var(--text-muted);
    }

    body.dark small.helper {
      color: #a29dc0;
    }

    .inline-row {
      display: flex;
      gap: 10px;
    }

    .inline-row > .field-group {
      flex: 1;
    }

    .points-banner {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(255, 247, 220, 0.9);
      color: #5c4713;
      margin-bottom: 8px;
      display: none;
    }

    body.dark .points-banner {
      background: rgba(41, 33, 85, 0.9);
      color: #ffe7a0;
    }

    .points-banner strong {
      font-weight: 700;
    }

    .last-order-banner {
      display: none;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #fff3cd;
      color: #856404;
      font-size: 12px;
    }

    body.dark .last-order-banner {
      background: #3f3420;
      color: #ffe7a0;
    }

    .last-order-banner button {
      margin-left: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      background: #ffc107;
      cursor: pointer;
      font-size: 11px;
    }

    body.dark .last-order-banner button {
      background: #ffd75b;
      color: #222;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--accent);
      color: #111;
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
    }

    .btn-secondary {
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
    }

    body.dark .btn-secondary {
      background: #191924;
      color: #eee;
      border-color: #44435a;
    }

    .btn span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-size: 14px;
    }

    .btn-primary span.icon {
      background: #111;
    }

    .btn-block {
      width: 100%;
      justify-content: center;
    }

    .cart-table {
      margin-top: 6px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 12px;
    }

    body.dark .cart-table {
      border-color: #343440;
    }

    .cart-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .cart-table th,
    .cart-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    body.dark .cart-table th,
    body.dark .cart-table td {
      border-bottom-color: #262638;
    }

    .cart-table th {
      background: rgba(0,0,0,0.03);
      text-align: left;
    }

    body.dark .cart-table th {
      background: #191924;
    }

    .cart-empty {
      font-size: 12px;
      color: var(--text-muted);
      padding: 6px 0;
    }

    body.dark .cart-empty {
      color: #a29dc0;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 8px;
      font-size: 13px;
    }

    .totals-row strong {
      font-size: 16px;
    }

    .totals-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    body.dark .totals-sub {
      color: #a29dc0;
    }

    .footer-note {
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-muted);
    }

    body.dark .footer-note {
      color: #a29dc0;
    }
  </style>
</head>
<body>
<div class="app">

  <div class="card hero">
    <header class="app-header">
      <div class="brand-block">
        <div class="brand-name">Monte Alto</div>
        <div class="brand-sub">CharcuterÃ­a artesanal</div>
      </div>
      <div class="mode-toggle" id="modeToggle">
        <span class="icon" id="modeIcon">â˜€</span>
        <span id="modeLabel">Modo claro</span>
      </div>
    </header>

    <h1>Monte Alto â€“ Calculadora</h1>
    <div class="hero-main-title">SeleccionÃ¡ tu chorizo</div>
    <div class="hero-subline">
      ElegÃ­ producto, gramaje y picante. Calculamos el total y los puntos.
    </div>

    <div class="hero-layout">
      <!-- Imagen / hero -->
      <div class="hero-image-wrap">
        <div class="hero-plate">
          <img id="heroImage"
               src="https://via.placeholder.com/480x320?text=Monte+Alto"
               alt="Producto Monte Alto">
        </div>

        <div class="hero-tag tag-left" id="heroTagLeft">
          <span class="icon">â˜…</span>
          <span>Favorito de la casa</span>
        </div>

        <div class="hero-tag tag-right" id="heroTagRight">
          <span class="icon">ðŸŒ¶</span>
          <span>Intensidad media</span>
        </div>
      </div>

      <!-- Texto producto -->
      <div class="hero-text-block">
        <div class="hero-product-name" id="heroProductName">Tex-Mex</div>
        <div class="hero-price-line" id="heroPrice">â‚¡0 / kg</div>
        <div class="hero-tagline" id="productTagline">
          Molienda fresca con especias tostadas y toque ahumado.
        </div>

        <div class="hero-meta-row">
          <span class="pill" id="heroYield">Rinde aprox. 3â€“4 porciones</span>
          <span class="pill" id="heroBaseGram">Sugerido: 500 g</span>
          <span class="pill" id="heroPoints">1 punto cada â‚¡100</span>
        </div>

        <div class="stock-warning" id="stockWarning" style="display:none;">
          Solo quedan X paquetes hoy.
        </div>
      </div>
    </div>
  </div>

  <div class="top-row">
    <!-- Formulario -->
    <div class="card form-cart">
      <div class="form-section-title">Datos del cliente</div>

      <div class="last-order-banner" id="lastOrderBanner">
        <span id="lastOrderText"></span>
        <button type="button" id="repeatLastBtn">Repetir</button>
      </div>

      <div class="points-banner" id="pointsBanner">
        <span id="pointsBannerText"></span>
      </div>

      <div class="inline-row">
        <div class="field-group">
          <label for="telefonoInput">TelÃ©fono (WhatsApp)</label>
          <input type="text" id="telefonoInput" placeholder="Ej: 6066-8322">
          <small class="helper">Usamos este nÃºmero para tus puntos y el resumen del pedido.</small>
        </div>
        <div class="field-group">
          <label for="nombreInput">Nombre</label>
          <input type="text" id="nombreInput" placeholder="Tu nombre">
        </div>
      </div>

      <div class="field-group">
        <button class="btn btn-secondary" type="button" id="buscarClienteBtn">
          <span class="icon">ðŸ‘€</span>
          Buscar puntos y Ãºltima compra
        </button>
      </div>

      <hr style="border:none; border-top:1px solid rgba(0,0,0,0.06); margin:10px 0;">

      <div class="form-section-title">Pedido</div>

      <div class="inline-row">
        <div class="field-group">
          <label for="productoSelect">Producto</label>
          <select id="productoSelect"></select>
        </div>
        <div class="field-group">
          <label for="picanteSelect">Picante</label>
          <select id="picanteSelect">
            <option value="">SeleccionÃ¡...</option>
            <option value="no">No picante</option>
            <option value="si">Picante</option>
          </select>
        </div>
      </div>

      <div class="inline-row">
        <div class="field-group">
          <label for="gramosInput">Gramos</label>
          <input type="number" id="gramosInput" min="100" step="50" placeholder="Ej: 500">
          <small class="helper">PodÃ©s escribir la cantidad que necesitÃ©s.</small>
        </div>
        <div class="field-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary btn-block" type="button" id="addToCartBtn">
            <span class="icon">ï¼‹</span>
            Agregar al carrito
          </button>
        </div>
      </div>

      <div class="field-group">
        <label for="comentariosInput">Notas / comentarios</label>
        <textarea id="comentariosInput" placeholder="Ej: cortar en rodajas, separar en paquetes de 500 g, etc."></textarea>
        <small class="helper">
          Si necesitÃ¡s el pedido con urgencia o para una fecha especÃ­fica, escribilo aquÃ­.
        </small>
      </div>

      <div class="form-section-title">Carrito</div>
      <div id="cartContainer">
        <div class="cart-empty" id="cartEmptyMsg">AÃºn no has agregado productos.</div>
        <div class="cart-table" id="cartTableWrapper" style="display:none;">
          <table>
            <thead>
            <tr>
              <th>Producto</th>
              <th>Gramos</th>
              <th>Picante</th>
              <th>Total</th>
              <th></th>
            </tr>
            </thead>
            <tbody id="cartTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="totals-row">
        <div>
          Total estimado:<br>
          <span class="totals-sub">Incluye todos los productos del carrito.</span>
        </div>
        <div>
          <strong id="totalDisplay">â‚¡0</strong><br>
          <span class="totals-sub">Puntos: <span id="pointsDisplay">0</span></span>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button class="btn btn-primary btn-block" type="button" id="enviarPedidoBtn">
          <span class="icon">ðŸ›’</span>
          Enviar pedido
        </button>
      </div>

      <div class="footer-note">
        AÃ±os de sabor artesanal, ahora con calculadora. Tus puntos no se pierden aunque apliquemos descuentos.
      </div>
    </div>
  </div>

</div>

<script>
  // =============================
  // CONFIGURACIÃ“N DE PRODUCTOS
  // =============================

const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw6r1oogKYA6uD5o0Eh7wkHE-idcreykcD7n4cTIn0OoXriF5219WOQVveAMAKJQEKZ/exec";

  
  const CONFIG = {
    colonesPorPunto: 100,
    productos: {
      texmex: {
        id: "texmex",
        nombre: "Tex-Mex",
        precioKg: 8500,
        tagline: "Molienda fresca con especias tostadas y un toque ahumado.",
        stockPaquetesHoy: 6,
        upsellSugeridoId: "criollo",
        rinde: "Rinde aprox. 3â€“4 porciones",
        imagen: "https://via.placeholder.com/480x320?text=Tex-Mex",
        picanteNivel: "Picante medio"
      },
      caribeno: {
        id: "caribeno",
        nombre: "CaribeÃ±o",
        precioKg: 8700,
        tagline: "Ajo fresco, coco natural y chile panameÃ±o costero.",
        stockPaquetesHoy: 5,
        upsellSugeridoId: null,
        rinde: "Ideal para 3â€“4 platos",
        imagen: "https://via.placeholder.com/480x320?text=Caribeno",
        picanteNivel: "Suave y aromÃ¡tico"
      },
      criollo: {
        id: "criollo",
        nombre: "Criollo Argentino",
        precioKg: 8300,
        tagline: "Receta clÃ¡sica con mezcla de posta y panceta.",
        stockPaquetesHoy: 4,
        upsellSugeridoId: null,
        rinde: "Perfecto para la parrilla",
        imagen: "https://via.placeholder.com/480x320?text=Criollo",
        picanteNivel: "ClÃ¡sico, no picante"
      },
      bratwurst: {
        id: "bratwurst",
        nombre: "Bratwurst",
        precioKg: 8900,
        tagline: "Suave, jugoso, estilo alemÃ¡n.",
        stockPaquetesHoy: 3,
        upsellSugeridoId: null,
        rinde: "Ideal para panes",
        imagen: "https://via.placeholder.com/480x320?text=Bratwurst",
        picanteNivel: "Suave"
      },
      bacon: {
        id: "bacon",
        nombre: "Bacon ahumado",
        precioKg: 10000,
        tagline: "Tocineta ahumada lentamente, corte grueso.",
        stockPaquetesHoy: 5,
        upsellSugeridoId: null,
        rinde: "AcompaÃ±a 3â€“4 recetas",
        imagen: "https://via.placeholder.com/480x320?text=Bacon",
        picanteNivel: "No picante"
      },
      comboSurtido: {
        id: "comboSurtido",
        nombre: "Combo surtido (500 g de cada chorizo)",
        precioKg: 0,
        precioFijo: 21000, // AJUSTA a tu realidad
        tagline: "Pack degustaciÃ³n con 500 g de cada chorizo Monte Alto.",
        stockPaquetesHoy: 3,
        upsellSugeridoId: null,
        rinde: "2.5 kg totales (5 sabores)",
        imagen: "https://via.placeholder.com/480x320?text=Combo+Surtido",
        picanteNivel: "DegustaciÃ³n completa",
        esCombo: true
      }
    }
  };

  // =============================
  // ESTADO
  // =============================
  let state = {
    telefono: "",
    nombre: "",
    puntos: 0,
    lastOrderSummary: null,
    lastOrderItems: null
  };

  let cart = [];

  // =============================
  // UTILIDADES
  // =============================
  function formatoColones(valor) {
    return "â‚¡" + (valor || 0).toLocaleString("es-CR");
  }

  function calcularPrecioProducto(prod, gramos) {
    if (!prod) return 0;
    if (prod.esCombo && prod.precioFijo) {
      return prod.precioFijo;
    }
    const g = gramos || 0;
    return Math.round(prod.precioKg * (g / 1000));
  }

  // =============================
  // UI INICIAL
  // =============================
  const productoSelect = document.getElementById("productoSelect");
  const picanteSelect = document.getElementById("picanteSelect");
  const gramosInput = document.getElementById("gramosInput");
  const heroImage = document.getElementById("heroImage");
  const heroProductName = document.getElementById("heroProductName");
  const heroPrice = document.getElementById("heroPrice");
  const productTaglineEl = document.getElementById("productTagline");
  const heroYieldEl = document.getElementById("heroYield");
  const heroBaseGramEl = document.getElementById("heroBaseGram");
  const stockWarningEl = document.getElementById("stockWarning");
  const heroTagLeft = document.getElementById("heroTagLeft");
  const heroTagRight = document.getElementById("heroTagRight");
  const totalDisplay = document.getElementById("totalDisplay");
  const pointsDisplay = document.getElementById("pointsDisplay");
  const cartEmptyMsg = document.getElementById("cartEmptyMsg");
  const cartTableWrapper = document.getElementById("cartTableWrapper");
  const cartTableBody = document.getElementById("cartTableBody");
  const pointsBanner = document.getElementById("pointsBanner");
  const pointsBannerText = document.getElementById("pointsBannerText");
  const lastOrderBanner = document.getElementById("lastOrderBanner");
  const lastOrderText = document.getElementById("lastOrderText");

  function initProductos() {
    productoSelect.innerHTML = "";
    Object.values(CONFIG.productos).forEach(prod => {
      const opt = document.createElement("option");
      opt.value = prod.id;
      opt.textContent = prod.nombre;
      productoSelect.appendChild(opt);
    });
    // default
    productoSelect.value = "texmex";
    onProductoChange();
  }

  function onProductoChange() {
    const prodId = productoSelect.value;
    const prod = CONFIG.productos[prodId];

    if (!prod) return;

    heroProductName.textContent = prod.nombre;
    heroImage.src = prod.imagen;
    heroImage.alt = prod.nombre;

    if (prod.esCombo) {
      heroPrice.textContent = prod.precioFijo
        ? formatoColones(prod.precioFijo) + " combo"
        : "Precio combo";
      heroBaseGramEl.textContent = "2.5 kg totales";
      gramosInput.value = 2500;
      gramosInput.disabled = true;
    } else {
      heroPrice.textContent = formatoColones(prod.precioKg) + " / kg";
      heroBaseGramEl.textContent = "Sugerido: 500 g";
      if (gramosInput.disabled) gramosInput.disabled = false;
      if (!gramosInput.value) gramosInput.value = 500;
    }

    productTaglineEl.textContent = prod.tagline || "";
    heroYieldEl.textContent = prod.rinde || "";
    heroTagLeft.querySelector("span.icon").textContent = "â˜…";
    heroTagLeft.querySelector("span:last-child").textContent =
      prod.esCombo ? "Pack degustaciÃ³n" : "Favorito de la casa";

    heroTagRight.querySelector("span.icon").textContent = "ðŸŒ¶";
    heroTagRight.querySelector("span:last-child").textContent =
      prod.picanteNivel || "Intensidad";

    // stock
    if (typeof prod.stockPaquetesHoy === "number" && prod.stockPaquetesHoy > 0) {
      if (prod.stockPaquetesHoy <= 4) {
        stockWarningEl.textContent =
          `Solo quedan ${prod.stockPaquetesHoy} paquetes hoy.`;
        stockWarningEl.style.display = "block";
      } else {
        stockWarningEl.style.display = "none";
      }
    } else {
      stockWarningEl.style.display = "none";
    }
  }

  productoSelect.addEventListener("change", onProductoChange);

  // =============================
  // CARRITO
  // =============================
  function addToCart() {
    const prodId = productoSelect.value;
    const prod = CONFIG.productos[prodId];
    if (!prod) return;

    let gramos = parseInt(gramosInput.value, 10) || 0;
    if (prod.esCombo) {
      gramos = 2500; // fijo para el combo
    }

    if (gramos <= 0) {
      alert("IndicÃ¡ los gramos que necesitÃ¡s.");
      return;
    }

    const picante = picanteSelect.value; // "si", "no" o ""

    const total = calcularPrecioProducto(prod, gramos);

    cart.push({
      productoId: prodId,
      nombre: prod.nombre,
      gramos,
      picante,
      total
    });

    renderCart();

    // limpiar campos de producto (pero no el producto seleccionado)
    gramosInput.value = prod.esCombo ? 2500 : "";
    picanteSelect.value = "";

    // upsell si aplica
    mostrarUpsell(prodId);
  }

  function mostrarUpsell(prodId) {
    const prod = CONFIG.productos[prodId];
    if (!prod || !prod.upsellSugeridoId) return;

    const sugerido = CONFIG.productos[prod.upsellSugeridoId];
    if (!sugerido) return;

    const msg =
      `Sugerencia Monte Alto:\n\n` +
      `Las personas que compran ${prod.nombre} tambiÃ©n suelen llevar ${sugerido.nombre}.\n\n` +
      `Â¿QuerÃ©s agregarlo tambiÃ©n?`;

    if (confirm(msg)) {
      agregarProductoDirecto(sugerido.id, 500);
    }
  }

  function agregarProductoDirecto(prodId, gramos) {
    const prod = CONFIG.productos[prodId];
    if (!prod) return;

    const total = calcularPrecioProducto(prod, gramos);
    cart.push({
      productoId: prodId,
      nombre: prod.nombre,
      gramos,
      picante: "",
      total
    });
    renderCart();
  }

  function eliminarDelCart(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function renderCart() {
    if (!cart.length) {
      cartEmptyMsg.style.display = "block";
      cartTableWrapper.style.display = "none";
    } else {
      cartEmptyMsg.style.display = "none";
      cartTableWrapper.style.display = "block";
    }

    cartTableBody.innerHTML = "";
    let total = 0;

    cart.forEach((item, idx) => {
      total += item.total || 0;
      const tr = document.createElement("tr");

      const tdProd = document.createElement("td");
      tdProd.textContent = item.nombre;

      const tdGram = document.createElement("td");
      tdGram.textContent = item.gramos + " g";

      const tdPic = document.createElement("td");
      tdPic.textContent = item.picante === "si"
        ? "Picante"
        : item.picante === "no"
          ? "No picante"
          : "-";

      const tdTot = document.createElement("td");
      tdTot.textContent = formatoColones(item.total);

      const tdDel = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.textContent = "âœ•";
      btnDel.className = "btn btn-secondary";
      btnDel.style.padding = "3px 8px";
      btnDel.style.fontSize = "11px";
      btnDel.addEventListener("click", () => eliminarDelCart(idx));
      tdDel.appendChild(btnDel);

      tr.appendChild(tdProd);
      tr.appendChild(tdGram);
      tr.appendChild(tdPic);
      tr.appendChild(tdTot);
      tr.appendChild(tdDel);

      cartTableBody.appendChild(tr);
    });

    totalDisplay.textContent = formatoColones(total);

    // puntos basados en total SIN descuento (descuento no afecta puntos)
    const puntos = Math.floor(total / CONFIG.colonesPorPunto);
    pointsDisplay.textContent = puntos;
  }

  document.getElementById("addToCartBtn").addEventListener("click", addToCart);

  // =============================
  // PUNTOS / CLIENTE
  // =============================
  const telefonoInput = document.getElementById("telefonoInput");
  const nombreInput = document.getElementById("nombreInput");

  document.getElementById("buscarClienteBtn").addEventListener("click", () => {
    const tel = telefonoInput.value.trim();
    if (!tel) {
      alert("IndicÃ¡ tu nÃºmero de telÃ©fono primero.");
      return;
    }

    state.telefono = tel;
    state.nombre = nombreInput.value.trim() || "";

    // TODO: AquÃ­ va la llamada real a Apps Script para traer puntos y Ãºltima compra.
    // SimulaciÃ³n por ahora:
    simularConsultaCliente(tel);
  });

  function simularConsultaCliente(tel) {
    // SimulaciÃ³n tonta: si termina en 22, tiene puntos y Ãºltima compra
    if (tel.endsWith("22")) {
      state.puntos = 250;
      state.lastOrderSummary = "Tex-Mex 1000 g + CaribeÃ±o 500 g";
      state.lastOrderItems = [
        { productoId: "texmex", nombre: "Tex-Mex", gramos: 1000, picante: "si", total: 8500 },
        { productoId: "caribeno", nombre: "CaribeÃ±o", gramos: 500, picante: "no", total: 4350 }
      ];
    } else {
      state.puntos = 0;
      state.lastOrderSummary = null;
      state.lastOrderItems = null;
    }

    renderPuntos();
    renderLastOrderBanner();
  }

  function renderPuntos() {
    if (state.puntos > 0) {
      pointsBannerText.innerHTML =
        `TenÃ©s <strong>${state.puntos} puntos</strong> acumulados. ` +
        `Cada â‚¡${CONFIG.colonesPorPunto.toLocaleString("es-CR")} suma 1 punto.`;
      pointsBanner.style.display = "block";
    } else {
      pointsBannerText.textContent =
        "Esta puede ser tu primera compra con puntos Monte Alto. Â¡Bienvenido!";
      pointsBanner.style.display = "block";
    }
  }

  function renderLastOrderBanner() {
    if (!state.lastOrderSummary) {
      lastOrderBanner.style.display = "none";
      return;
    }
    lastOrderText.textContent =
      `La Ãºltima vez compraste ${state.lastOrderSummary}. Â¿QuerÃ©s repetir algo similar?`;
    lastOrderBanner.style.display = "block";
  }

  document.getElementById("repeatLastBtn").addEventListener("click", () => {
    if (!state.lastOrderItems || !Array.isArray(state.lastOrderItems)) return;
    cart = state.lastOrderItems.map(item => ({ ...item }));
    renderCart();
    alert("Listo, cargamos un pedido similar al de la vez pasada. PodÃ©s ajustarlo antes de enviar.");
  });

  // =============================
  // ENVIAR PEDIDO
  // =============================
  document.getElementById("enviarPedidoBtn").addEventListener("click", () => {
    if (!cart.length) {
      alert("AgregÃ¡ al menos un producto al carrito antes de enviar.");
      return;
    }

    const tel = telefonoInput.value.trim();
    const nom = nombreInput.value.trim();
    if (!tel || !nom) {
      alert("IndicÃ¡ tu telÃ©fono y nombre antes de enviar el pedido.");
      return;
    }

    const comentarios = document.getElementById("comentariosInput").value.trim();
    const total = cart.reduce((acc, item) => acc + (item.total || 0), 0);
    const puntosGanados = Math.floor(total / CONFIG.colonesPorPunto);

    const resumenLineas = cart.map(item => {
      const pic = item.picante === "si"
        ? " (picante)"
        : item.picante === "no"
          ? " (no picante)"
          : "";
      return `â€¢ ${item.nombre} â€“ ${item.gramos} g${pic}: ${formatoColones(item.total)}`;
    }).join("\n");

    const mensaje =
      `Pedido Monte Alto â€“ ${nom} (${tel})\n\n` +
      `${resumenLineas}\n\n` +
      `Total: ${formatoColones(total)}\n` +
      `Puntos por esta compra: ${puntosGanados}\n\n` +
      (comentarios ? `Notas del cliente:\n${comentarios}\n\n` : "") +
      `Tus descuentos NO reducen tus puntos acumulados.`;

    // TODO: aquÃ­ debÃ©s:
    // 1) Enviar al Apps Script (saveOrder) con el payload actual.
    // 2) Opcionalmente abrir WhatsApp con el mensaje.

    console.log("Mensaje de pedido:", mensaje);
    alert("SimulaciÃ³n de envÃ­o:\n\n" + mensaje);
  });

  // =============================
  // MODO CLARO / OSCURO
  // =============================
  const modeToggle = document.getElementById("modeToggle");
  const modeIcon = document.getElementById("modeIcon");
  const modeLabel = document.getElementById("modeLabel");

  function aplicarTema(desired) {
    const tema = desired || localStorage.getItem("ma_theme") || "light";
    if (tema === "dark") {
      document.body.classList.add("dark");
      modeIcon.textContent = "ðŸŒ™";
      modeLabel.textContent = "Modo oscuro";
    } else {
      document.body.classList.remove("dark");
      modeIcon.textContent = "â˜€";
      modeLabel.textContent = "Modo claro";
    }
    localStorage.setItem("ma_theme", tema);
  }

  modeToggle.addEventListener("click", () => {
    const actualEsDark = document.body.classList.contains("dark");
    aplicarTema(actualEsDark ? "light" : "dark");
  });

  // =============================
  // INIT
  // =============================
  window.addEventListener("DOMContentLoaded", () => {
    initProductos();
    aplicarTema();
  });
</script>

</body>
</html>
