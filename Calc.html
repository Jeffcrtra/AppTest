<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>10.52 Embutidos Monte Alto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-main: #05060a;
      --bg-card-top: #191c24;
      --bg-card-bottom: #11131a;
      --accent: #ffd54a;
      --text-main: #f7f5ff;
      --text-muted: #9a9fb5;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.6);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #252735 0, #05060a 60%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      color: var(--text-main);
    }

    .app {
      width: 100%;
      max-width: 420px;
      margin: 16px;
      background: transparent;
      display: flex;
      flex-direction: column;
      border-radius: 32px;
      overflow: hidden;
    }

    .card-top {
      background: var(--bg-card-top);
      border-radius: 32px 32px 0 0;
      padding: 14px 18px 20px 18px;
      box-shadow: var(--shadow-soft);
      position: relative;
      z-index: 2;
      color: var(--text-main);
    }

    .title-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    h1 {
      font-size: 14px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .hero-name-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }

    .hero-name {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.1;
      color: #fdfdfd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hero-price {
      font-size: 16px;
      font-weight: 700;
      color: #f7b94a;
      white-space: nowrap;
    }

    .hero-sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* CARRUSEL */

    .hero-carousel-wrap {
      margin: 14px 0 8px;
      position: relative;
    }

    .carousel-viewport {
      position: relative;
      overflow: hidden;
      padding: 6px 0;
    }

    .carousel-viewport::before,
    .carousel-viewport::after {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      width: 24px;
      pointer-events: none;
      z-index: 3;
    }

    .carousel-viewport::before {
      left: 0;
      background: linear-gradient(
        to right,
        rgba(25,28,36,1) 0%,
        rgba(25,28,36,0) 100%
      );
    }

    .carousel-viewport::after {
      right: 0;
      background: linear-gradient(
        to left,
        rgba(25,28,36,1) 0%,
        rgba(25,28,36,0) 100%
      );
    }

    .carousel-track {
      display: flex;
      gap: 0;
      transition: transform 0.45s ease;
      will-change: transform;
    }

    .slide {
      flex: 0 0 100%;
      border-radius: 28px;
      background: radial-gradient(circle at top, #f6e1c8 0, #d9a66b 60%, #b6793e 100%);
      height: 160px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      overflow: hidden;
      position: relative;
      transform-origin: center center;
      transition:
        transform 0.35s ease,
        opacity 0.35s ease,
        box-shadow 0.35s ease;
      opacity: 0.4;
      transform: scale(0.97);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slide.active {
      opacity: 1;
      transform: scale(1);
      box-shadow: 0 24px 52px rgba(0,0,0,0.6);
    }

    .slide img {
      width: 112%;
      height: auto;
      object-fit: cover;
      transform: translateY(4px);
    }

    /* Pastillas sobre la imagen */

    .slide-pill {
      position: absolute;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: 999px;
      background: #1f3248;
      color: #f7f5ff;
      font-size: 11px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.45);
      z-index: 5;
      white-space: nowrap;
    }

    .slide-pill-top {
      left: 10px;
      top: 10px;
    }

    .slide-pill-bottom {
      right: 10px;
      bottom: 10px;
    }

    .pill-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: #24364a;
      color: #f7f5ff;
    }

    .pill-icon-fav {
      background: #37c875;
      color: #07341e;
    }

    .arrow-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: radial-gradient(circle at 30% 20%, #2a2d35 0, #090b10 70%);
      box-shadow: 0 12px 28px rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 4;
      color: #f7f5ff;
      font-size: 18px;
    }

    .arrow-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    .arrow-prev { left: -4px; }
    .arrow-next { right: -4px; }

    .dots {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      gap: 6px;
      font-size: 0;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #3b3f4a;
      transition: background 0.2s, transform 0.2s;
    }

    .dot.active {
      background: #f0b04a;
      transform: scale(1.4);
    }

    .hero-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .hero-desc {
      font-size: 13px;
      margin-top: 4px;
      color: #c7cadb;
    }

    /* bottom card (oscura) */

    .card-bottom {
      margin-top: -18px;
      background: var(--bg-card-bottom);
      border-radius: 28px;
      padding: 20px 18px 18px;
      color: #f6f5ff;
      box-shadow: 0 -8px 30px rgba(0,0,0,0.5);
    }

    .bottom-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .bottom-header h2 {
      font-size: 15px;
      font-weight: 600;
    }

    .badge-soft {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
    }

    .product-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 14px;
    }

    .product-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 18px;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .product-row.active {
      background: rgba(255,255,255,0.16);
      transform: translateY(-1px);
    }

    .product-thumb {
      width: 46px;
      height: 46px;
      border-radius: 18px;
      overflow: hidden;
      background: radial-gradient(circle at top, #f3d7a2 0, #b3743a 70%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-thumb img {
      width: 120%;
      height: auto;
      object-fit: cover;
    }

    .product-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .product-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-desc {
      font-size: 11px;
      color: #a49fb0;
    }

    .product-meta {
      text-align: right;
      font-size: 11px;
      color: #c3bdce;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .product-meta strong {
      font-size: 13px;
      color: #ffd976;
    }

    /* Panel desplegable bajo producto */

    .product-details-panel {
      margin: 4px 4px 10px 54px;
      padding: 10px 12px 12px;
      border-radius: 16px;
      background: #0b3c4f;
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 11px;
      color: #e3eff7;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      align-items: center;
    }

    .field-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #c0d9e6;
    }

    .field-input,
    .field-select,
    .field-notes {
      width: 100%;
      border-radius: 8px;
      border: none;
      padding: 6px 8px;
      font-size: 12px;
      font-family: inherit;
      color: #f7fafe;
      background: rgba(0,0,0,0.28);
      outline: none;
    }

    .field-input::placeholder,
    .field-notes::placeholder {
      color: rgba(230,242,255,0.6);
    }

    .field-select {
      appearance: none;
    }

    /* Picante = SÃ­ -> naranja de advertencia */
    .field-select.spicy-yes {
      background: #7b2e14;
      color: #ffeede;
      font-weight: 600;
    }

    .field-notes {
      resize: vertical;
      min-height: 40px;
      max-height: 80px;
    }

    .details-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .btn-mini-add {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 600;
      background: var(--accent);
      color: #161616;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
      overflow: visible;
    }

    .btn-mini-add span.icon {
      font-size: 13px;
    }

    .bottom-footer {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .subtotal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #d9d4e5;
    }

    .subtotal-row strong {
      font-size: 16px;
      color: #ffffff;
    }

    .cart-row {
      font-size: 11px;
      color: #b6b0cf;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-primary {
      margin-top: 4px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      background: var(--accent);
      color: #161616;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
    }

    .btn-primary span.icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-size: 16px;
    }

    .points-row {
      font-size: 11px;
      color: #ada6c7;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .points-row span.highlight {
      color: #ffe789;
      font-weight: 600;
    }

    @media (max-width: 360px) {
      .hero-name {
        font-size: 21px;
      }
    }

    /* Confetti */

    .confetti-container {
      position: fixed;
      left: 0;
      top: 0;
      pointer-events: none;
      z-index: 9999;
    }

    .confetti-piece {
      position: absolute;
      width: 4px;
      height: 8px;
      opacity: 0;
      border-radius: 1px;
      animation: confetti-fall 700ms ease-out forwards;
    }

    @keyframes confetti-fall {
      0% {
        transform: translate(0,0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translate(var(--dx), var(--dy)) rotate(var(--rot));
        opacity: 0;
      }
    }

    /* Modal carrito */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: flex-end;
      z-index: 9000;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-panel {
      width: 100%;
      max-width: 420px;
      background: #11131a;
      border-radius: 20px 20px 0 0;
      padding: 16px 18px 18px;
      box-shadow: 0 -8px 32px rgba(0,0,0,0.8);
      color: #f7f5ff;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      font-size: 15px;
      font-weight: 600;
    }

    .modal-close {
      border: none;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #262938;
      color: #f7f5ff;
      cursor: pointer;
    }

    .cart-items {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 6px;
      margin-bottom: 8px;
    }

    .cart-item-row {
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cart-item-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cart-item-name {
      font-weight: 600;
    }

    .cart-item-notes {
      font-size: 11px;
      color: #b6b0cf;
    }

    .modal-footer {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .modal-footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-btn-ok {
      margin-top: 4px;
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 600;
      background: var(--accent);
      color: #111;
      cursor: pointer;
      width: 100%;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card-top">
    <div class="title-section">
      <h1>Embutidos Monte Alto</h1>
      <div class="hero-name-row">
        <div class="hero-name" id="heroName">Bratwurst</div>
        <div class="hero-price" id="heroPrice">â‚¡8 900 / kg</div>
      </div>
      <div class="hero-sub" id="heroSub">Suave, mantecoso, estilo alemÃ¡n</div>
    </div>

    <div class="hero-carousel-wrap">
      <div class="carousel-viewport">
        <div class="carousel-track" id="carouselTrack">
          <!-- slides generados por JS -->
        </div>
        <button class="arrow-btn arrow-prev" id="prevBtn" aria-label="Anterior">â€¹</button>
        <button class="arrow-btn arrow-next" id="nextBtn" aria-label="Siguiente">â€º</button>
      </div>
      <div class="dots" id="dots"></div>
    </div>

    <div class="hero-meta-row">
      <span id="heroMeta">Para 3â€“4 panes</span>
      <span id="heroRightMeta">500 g sugeridos</span>
    </div>
    <p class="hero-desc" id="heroDesc">
      Suave, jugoso, perfecto para hot dogs premium.
    </p>
  </div>

  <div class="card-bottom">
    <div class="bottom-header">
      <h2>Nuestros productos</h2>
      <span class="badge-soft">Toca para seleccionar</span>
    </div>

    <div class="product-list" id="productList">
      <!-- filas generadas por JS -->
    </div>

    <div class="bottom-footer">
      <div class="subtotal-row">
        <span id="subtotalLabel">Subtotal estimado (500 g)</span>
        <strong id="subtotalDisplay">â‚¡0</strong>
      </div>
      <div class="cart-row" id="cartRow">
        <span>Carrito: 0 productos</span>
        <span>â‚¡0</span>
      </div>
      <button class="btn-primary" id="addBtn">
        <span>Revisar orden</span>
        <span class="icon">ï¼‹</span>
      </button>
      <div class="points-row">
        <span>Puntos acumulables por esta compra:</span>
        <span class="highlight" id="pointsDisplay">0 pts</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal carrito -->
<div id="cartModal" class="modal-backdrop">
  <div class="modal-panel">
    <div class="modal-header">
      <h3>Tu orden</h3>
      <button class="modal-close" id="cartCloseBtn">âœ•</button>
    </div>
    <div class="cart-items" id="cartItems"></div>
    <div class="modal-footer">
      <div class="modal-footer-row">
        <span>Total:</span>
        <strong id="cartTotal">â‚¡0</strong>
      </div>
      <button class="modal-btn-ok" id="cartOkBtn">Cerrar</button>
    </div>
  </div>
</div>

<script>
  // URL de tu Apps Script (ya me la habÃ­as dado antes)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw6r1oogKYA6uD5o0Eh7wkHE-idcreykcD7n4cTIn0OoXriF5219WOQVveAMAKJQEKZ/exec";

  // Valores por defecto (se usan hasta que lleguen los del Sheet)
  let priceChorizo = 8500;
  let priceTocineta = 10000;
  let priceComboTotal = 25000;

  // Productos Monte Alto â€“ laboratorio carrusel
  const PRODUCTS = [
    {
      id: "texmex",
      nombre: "Tex-Mex",
      tipo: "chorizo",
      precioKg: 8500,
      favorito: true,
      featureIcon: "ðŸ”¥",
      featureText: "Picante medio",
      tagline: "Chorizo artesanal picante",
      descHero: "Molienda fresca con especias tostadas y un toque ahumado.",
      descCorta: "Especiado, ahumado y ligeramente picante.",
      rinde: "Rinde 3â€“4 porciones",
      img: "Tex-Mex-02.png"
    },
    {
      id: "caribeno",
      nombre: "CaribeÃ±o",
      tipo: "chorizo",
      precioKg: 8700,
      favorito: true,
      featureIcon: "ðŸ¥¥",
      featureText: "Coco + chile panameÃ±o",
      tagline: "Coco natural + chile panameÃ±o",
      descHero: "Ajo fresco, coco natural y chile panameÃ±o estilo costero.",
      descCorta: "Toque caribeÃ±o con coco y chile panameÃ±o.",
      rinde: "Perfecto para 3 platos",
      img: "CaribeÃ±o-02.png"
    },
    {
      id: "tico",
      nombre: "Tico Casero",
      tipo: "chorizo",
      precioKg: 8300,
      favorito: false,
      featureIcon: "ðŸ‡¨ðŸ‡·",
      featureText: "Tico tradicional",
      tagline: "Achiote, ajo y tradiciÃ³n local",
      descHero: "Receta casera con achiote, ajo fresco y especias ticas.",
      descCorta: "Sabor tico clÃ¡sico para desayuno y choripÃ¡n.",
      rinde: "Ideal para desayunos y choripanes",
      img: "Criollo-02.png"
    },
    {
      id: "argentino",
      nombre: "Criollo Argentino",
      tipo: "chorizo",
      precioKg: 8300,
      favorito: false,
      featureIcon: "ðŸ¥©",
      featureText: "Posta + panceta",
      tagline: "ClÃ¡sico para parrilla",
      descHero: "Posta y panceta en equilibrio, sabor limpio y jugoso.",
      descCorta: "ClÃ¡sico parrillero, mezcla de posta y panceta.",
      rinde: "Ideal para la parrilla",
      img: "Argentino-02.png"
    },
    {
      id: "bratwurst",
      nombre: "Bratwurst",
      tipo: "chorizo",
      precioKg: 8900,
      favorito: false,
      featureIcon: "ðŸ‡©ðŸ‡ª",
      featureText: "Estilo alemÃ¡n",
      tagline: "Suave, mantecoso, estilo alemÃ¡n",
      descHero: "Suave, jugoso, perfecto para hot dogs premium.",
      descCorta: "Suave estilo alemÃ¡n para panes.",
      rinde: "Para 3â€“4 panes",
      img: "Bratwurst-02.png"
    },
    {
      id: "tocineta",
      nombre: "Tocineta Ahumada",
      tipo: "tocineta",
      precioKg: 10000,
      favorito: true,
      featureIcon: "ðŸ¥“",
      featureText: "Ahumado lento",
      tagline: "Laminada, ahumada en frÃ­o",
      descHero: "Tocineta ahumada lentamente, ideal para desayunos y burgers.",
      descCorta: "LÃ¡minas ahumadas para todo.",
      rinde: "Rinde varias preparaciones",
      img: "Tocineta-02.png"
    },
    {
      id: "combo",
      nombre: "Combo surtido Monte Alto",
      tipo: "combo",
      precioKg: 25000, // este es el precio total del combo, no /kg
      favorito: false,
      featureIcon: "ðŸŒŸ",
      featureText: "SerÃ¡s la estrella de la fiesta",
      tagline: "500 g de cada chorizo",
      descHero: "DegustaciÃ³n completa: 500 g de cada chorizo Monte Alto.",
      descCorta: "Pack de 2.5 kg para compartir.",
      rinde: "Ideal para parrilladas y regalos",
      img: "Combo-02.png"
    }
  ];

  // Aplica los precios chorizo/tocineta/combo a los productos
  function applyBackendPrices() {
    PRODUCTS.forEach(p => {
      if (p.tipo === "tocineta") {
        p.precioKg = priceTocineta;
      } else if (p.tipo === "combo") {
        p.precioKg = priceComboTotal;
      } else if (p.tipo === "chorizo") {
        p.precioKg = priceChorizo;
      }
    });
  }

  async function loadPricesFromSheet() {
    try {
      console.log("Llamando a getLabPrices en Apps Script...");
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "getLabPrices" })
      });
  
      console.log("HTTP status:", res.status, res.statusText);
  
      const data = await res.json().catch(err => {
        console.error("No pude parsear JSON:", err);
        return null;
      });
  
      console.log("Respuesta getLabPrices:", data);
  
      if (!data || data.success === false) {
        console.error("getLabPrices devolviÃ³ error o formato inesperado");
        return;
      }
  
      if (typeof data.chorizo === "number" && data.chorizo > 0) {
        priceChorizo = data.chorizo;
      }
      if (typeof data.tocineta === "number" && data.tocineta > 0) {
        priceTocineta = data.tocineta;
      }
      if (typeof data.comboTotal === "number" && data.comboTotal > 0) {
        priceComboTotal = data.comboTotal;
      }
  
      applyBackendPrices();
      updateUI();
      updateCartRow();
    } catch (err) {
      console.error("Error cargando precios desde Google Sheets. Se usan valores por defecto.", err);
    }
  }


  const HERO_NAME = document.getElementById("heroName");
  const HERO_PRICE = document.getElementById("heroPrice");
  const HERO_SUB = document.getElementById("heroSub");
  const HERO_META = document.getElementById("heroMeta");
  const HERO_RIGHT_META = document.getElementById("heroRightMeta");
  const HERO_DESC = document.getElementById("heroDesc");

  const track = document.getElementById("carouselTrack");
  const viewportEl = document.querySelector(".carousel-viewport");
  const dotsContainer = document.getElementById("dots");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  const PRODUCT_LIST = document.getElementById("productList");
  const SUBTOTAL_LABEL = document.getElementById("subtotalLabel");
  const SUBTOTAL_DISPLAY = document.getElementById("subtotalDisplay");
  const POINTS_DISPLAY = document.getElementById("pointsDisplay");
  const ADD_BTN = document.getElementById("addBtn");
  const CART_ROW = document.getElementById("cartRow");

  const CART_MODAL = document.getElementById("cartModal");
  const CART_ITEMS = document.getElementById("cartItems");
  const CART_TOTAL = document.getElementById("cartTotal");
  const CART_CLOSE_BTN = document.getElementById("cartCloseBtn");
  const CART_OK_BTN = document.getElementById("cartOkBtn");

  let currentIndex = 0;
  let slides = [];
  const gramosBase = 500;
  const gramosComboFijo = 2500;
  const colonesPorPunto = 100;

  const cart = [];
  const selectionState = {};
  let expandedId = null; // por defecto panel oculto

  function getSelection(prodId) {
    if (!selectionState[prodId]) {
      selectionState[prodId] = {
        peso: gramosBase,
        picante: "No",
        notas: ""
      };
    }
    return selectionState[prodId];
  }

  function formatoColones(valor) {
    return "â‚¡" + valor.toLocaleString("es-CR");
  }

  function calcularSubtotalKg(prod, gramos) {
    if (!prod.precioKg || prod.precioKg <= 0) return 0;
    return Math.round(prod.precioKg * (gramos / 1000));
  }

  /* ----- CONFETTI ----- */

  function triggerConfettiFromElement(el) {
    const rect = el.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;

    const container = document.createElement("div");
    container.className = "confetti-container";
    container.style.left = "0px";
    container.style.top = "0px";

    const colors = ["#ffd54a", "#ff8a65", "#4dd0e1", "#ce93d8", "#81c784"];
    const pieces = 24;

    for (let i = 0; i < pieces; i++) {
      const piece = document.createElement("div");
      piece.className = "confetti-piece";
      piece.style.backgroundColor = colors[i % colors.length];
      const dx = (Math.random() * 140 - 70) + "px";
      const dy = (Math.random() * -120 - 40) + "px";
      const rot = (Math.random() * 360) + "deg";
      piece.style.setProperty("--dx", dx);
      piece.style.setProperty("--dy", dy);
      piece.style.setProperty("--rot", rot);
      piece.style.left = x + "px";
      piece.style.top = y + "px";
      container.appendChild(piece);
    }

    document.body.appendChild(container);
    setTimeout(() => container.remove(), 800);
  }

  /* ----- CARRUSEL ----- */

  function createSlides() {
    PRODUCTS.forEach((p, idx) => {
      const slide = document.createElement("div");
      slide.className = "slide";
      slide.dataset.index = idx.toString();

      const favPill = p.favorito
        ? `<div class="slide-pill slide-pill-top">
             <span class="pill-icon pill-icon-fav">â˜…</span>
             <span>Favorito de la casa</span>
           </div>`
        : "";

      const featurePill = `
        <div class="slide-pill slide-pill-bottom">
          <span class="pill-icon">${p.featureIcon}</span>
          <span>${p.featureText}</span>
        </div>`;

      slide.innerHTML = `
        ${favPill}
        ${featurePill}
        <img src="${p.img}" alt="${p.nombre}">
      `;

      slide.addEventListener("click", () => {
        const index = Number(slide.dataset.index);
        currentIndex = index;
        expandedId = PRODUCTS[index].id; // abre panel al tocar imagen
        updateUI();
      });

      track.appendChild(slide);
    });

    slides = Array.from(track.querySelectorAll(".slide"));

    PRODUCTS.forEach((_p, idx) => {
      const d = document.createElement("div");
      d.className = "dot";
      d.dataset.index = idx.toString();
      d.addEventListener("click", () => {
        currentIndex = idx;
        expandedId = null; // solo navegar
        updateUI();
      });
      dotsContainer.appendChild(d);
    });
  }

  function updateCarouselClasses() {
    slides.forEach(s => s.classList.remove("active"));
    if (slides[currentIndex]) {
      slides[currentIndex].classList.add("active");
    }
  }

  function updateDots() {
    const dots = Array.from(dotsContainer.querySelectorAll(".dot"));
    dots.forEach((d, idx) => {
      d.classList.toggle("active", idx === currentIndex);
    });
  }

  function updateTrackPosition() {
    if (!slides.length) return;
    const slideWidth = viewportEl.offsetWidth; // evitar corrimiento acumulado
    const offset = currentIndex * slideWidth;
    track.style.transform = `translateX(-${offset}px)`;
  }

  /* ----- LISTA INFERIOR + PANEL ----- */

  function applyPicanteStyle(selectEl) {
    if (!selectEl) return;
    if (selectEl.value === "SÃ­") {
      selectEl.classList.add("spicy-yes");
    } else {
      selectEl.classList.remove("spicy-yes");
    }
  }

  function renderProductList() {
    PRODUCT_LIST.innerHTML = "";

    PRODUCTS.forEach((prod, idx) => {
      const row = document.createElement("div");
      row.className = "product-row";
      row.dataset.index = idx.toString();
      if (idx === currentIndex) row.classList.add("active");

      const thumb = document.createElement("div");
      thumb.className = "product-thumb";
      const img = document.createElement("img");
      img.src = prod.img;
      img.alt = prod.nombre;
      thumb.appendChild(img);

      const info = document.createElement("div");
      info.className = "product-info";
      const name = document.createElement("div");
      name.className = "product-name";
      name.textContent = prod.nombre;
      const desc = document.createElement("div");
      desc.className = "product-desc";
      desc.textContent = prod.descCorta;
      info.appendChild(name);
      info.appendChild(desc);

      const meta = document.createElement("div");
      meta.className = "product-meta";
      const price = document.createElement("div");
      price.innerHTML = prod.precioKg > 0
        ? `<strong>${formatoColones(prod.precioKg)}</strong>`
        : `<strong>Combo</strong>`;
      const rinde = document.createElement("div");
      rinde.textContent = prod.rinde;
      meta.appendChild(price);
      meta.appendChild(rinde);

      row.appendChild(thumb);
      row.appendChild(info);
      row.appendChild(meta);

      row.addEventListener("click", () => {
        currentIndex = idx;
        expandedId = (expandedId === prod.id) ? null : prod.id;
        updateUI();
      });

      PRODUCT_LIST.appendChild(row);

      if (expandedId === prod.id) {
        const state = getSelection(prod.id);
        const panel = document.createElement("div");
        panel.className = "product-details-panel";

        if (prod.tipo === "combo") {
          // Panel especial: sin peso, solo picante + notas
          panel.innerHTML = `
            <div class="field-block">
              <div class="field-label">Picante</div>
              <select class="field-select" data-field="picante">
                <option value="No"${state.picante === "No" ? " selected" : ""}>No</option>
                <option value="SÃ­"${state.picante === "SÃ­" ? " selected" : ""}>SÃ­</option>
              </select>
            </div>
            <div class="field-block">
              <div class="field-label">Notas</div>
              <textarea class="field-notes"
                        placeholder="Pedido urgente"
                        data-field="notas">${state.notas}</textarea>
            </div>
            <div class="details-footer">
              <button class="btn-mini-add">
                <span>Agregar a carrito</span>
                <span class="icon">ï¼‹</span>
              </button>
            </div>
          `;
        } else {
          // Panel normal con peso + picante + notas
          panel.innerHTML = `
            <div class="field-row">
              <div class="field-block">
                <div class="field-label">Peso (g)</div>
                <input type="number" min="100" step="50"
                       class="field-input"
                       value="${state.peso}"
                       data-field="peso">
              </div>
              <div class="field-block">
                <div class="field-label">Picante</div>
                <select class="field-select${state.picante === "SÃ­" ? " spicy-yes" : ""}" data-field="picante">
                  <option value="No"${state.picante === "No" ? " selected" : ""}>No</option>
                  <option value="SÃ­"${state.picante === "SÃ­" ? " selected" : ""}>SÃ­</option>
                </select>
              </div>
            </div>
            <div class="field-block">
              <div class="field-label">Notas</div>
              <textarea class="field-notes"
                        placeholder="Pedido urgente"
                        data-field="notas">${state.notas}</textarea>
            </div>
            <div class="details-footer">
              <button class="btn-mini-add">
                <span>Agregar a carrito</span>
                <span class="icon">ï¼‹</span>
              </button>
            </div>
          `;
        }

        const pesoInput = panel.querySelector('[data-field="peso"]');
        const picanteSelect = panel.querySelector('[data-field="picante"]');
        const notasArea = panel.querySelector('[data-field="notas"]');
        const miniBtn = panel.querySelector(".btn-mini-add");

        if (pesoInput) {
          pesoInput.addEventListener("input", (e) => {
            const v = parseInt(e.target.value, 10);
            state.peso = isNaN(v) ? "" : v;
          });
        }

        if (picanteSelect) {
          picanteSelect.addEventListener("change", (e) => {
            state.picante = e.target.value;
            applyPicanteStyle(e.target);
          });
          applyPicanteStyle(picanteSelect);
        }

        if (notasArea) {
          notasArea.addEventListener("input", (e) => {
            state.notas = e.target.value;
          });
        }

        miniBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          addToCart(prod, state);
          triggerConfettiFromElement(miniBtn);
        });

        PRODUCT_LIST.appendChild(panel);
      }
    });
  }

  /* ----- HERO + SUBTOTAL/PUNTOS (500 g referencia o combo total) ----- */

  function updateHero() {
    const prod = PRODUCTS[currentIndex];
    HERO_NAME.textContent = prod.nombre;
    HERO_SUB.textContent = prod.tagline || "Producto Monte Alto";
    HERO_META.textContent = prod.rinde;

    let subtotal = 0;

    if (prod.tipo === "combo") {
      HERO_PRICE.textContent = formatoColones(prod.precioKg);
      HERO_RIGHT_META.textContent = "";
      SUBTOTAL_LABEL.textContent = "Subtotal combo";
      subtotal = prod.precioKg || 0;
      SUBTOTAL_DISPLAY.textContent = subtotal > 0
        ? formatoColones(subtotal)
        : "Sin precio";
    } else {
      HERO_PRICE.textContent = `${formatoColones(prod.precioKg)} / kg`;
      HERO_RIGHT_META.textContent = "500 g sugeridos";
      SUBTOTAL_LABEL.textContent = "Subtotal estimado (500 g)";
      subtotal = calcularSubtotalKg(prod, gramosBase);
      SUBTOTAL_DISPLAY.textContent = subtotal > 0
        ? formatoColones(subtotal)
        : "â€”";
    }

    HERO_DESC.textContent = prod.descHero;

    const puntos = subtotal > 0 ? Math.floor(subtotal / colonesPorPunto) : 0;
    POINTS_DISPLAY.textContent = puntos + " pts";
  }

  /* ----- CARRITO ----- */

  function updateCartRow() {
    const totalProductos = cart.length;
    const totalColones = cart.reduce((sum, item) => sum + item.subtotal, 0);
    CART_ROW.firstElementChild.textContent = `Carrito: ${totalProductos} producto${totalProductos !== 1 ? "s" : ""}`;
    CART_ROW.lastElementChild.textContent = formatoColones(totalColones);
  }

  function addToCart(prod, stateOverride) {
    const state = stateOverride || getSelection(prod.id);
    let gramos;
    let subtotal;

    if (prod.tipo === "combo") {
      gramos = gramosComboFijo;
      subtotal = prod.precioKg || priceComboTotal;
    } else {
      gramos = Number(state.peso) || gramosBase;
      subtotal = calcularSubtotalKg(prod, gramos);
    }

    cart.push({
      id: prod.id,
      nombre: prod.nombre,
      gramos,
      picante: state.picante,
      notas: state.notas,
      subtotal
    });
    updateCartRow();
    console.log("Carrito (demo):", cart);
  }

  function buildCartModal() {
    CART_ITEMS.innerHTML = "";
    if (!cart.length) {
      const empty = document.createElement("div");
      empty.textContent = "Tu carrito estÃ¡ vacÃ­o.";
      empty.style.fontSize = "12px";
      empty.style.color = "#b6b0cf";
      CART_ITEMS.appendChild(empty);
    } else {
      cart.forEach(item => {
        const row = document.createElement("div");
        row.className = "cart-item-row";

        const main = document.createElement("div");
        main.className = "cart-item-main";

        const left = document.createElement("div");
        left.className = "cart-item-name";
        left.textContent = `${item.nombre} â€“ ${
          item.gramos ? item.gramos + " g" : ""
        }${item.picante === "SÃ­" ? " (picante)" : ""}`;

        const right = document.createElement("div");
        right.textContent = formatoColones(item.subtotal);

        main.appendChild(left);
        main.appendChild(right);
        row.appendChild(main);

        if (item.notas) {
          const notes = document.createElement("div");
          notes.className = "cart-item-notes";
          notes.textContent = item.notas;
          row.appendChild(notes);
        }

        CART_ITEMS.appendChild(row);
      });
    }

    const totalColones = cart.reduce((sum, item) => sum + item.subtotal, 0);
    CART_TOTAL.textContent = formatoColones(totalColones);
  }

  function openCartModal() {
    buildCartModal();
    CART_MODAL.classList.add("show");
  }

  function closeCartModal() {
    CART_MODAL.classList.remove("show");
  }

  ADD_BTN.addEventListener("click", openCartModal);
  CART_CLOSE_BTN.addEventListener("click", closeCartModal);
  CART_OK_BTN.addEventListener("click", closeCartModal);
  CART_MODAL.addEventListener("click", (e) => {
    if (e.target === CART_MODAL) closeCartModal();
  });

  /* ----- CONTROL FLECHAS Y RESIZE ----- */

  prevBtn.addEventListener("click", () => {
    currentIndex = (currentIndex - 1 + PRODUCTS.length) % PRODUCTS.length;
    expandedId = null;
    updateUI();
  });

  nextBtn.addEventListener("click", () => {
    currentIndex = (currentIndex + 1) % PRODUCTS.length;
    expandedId = null;
    updateUI();
  });

  window.addEventListener("resize", updateTrackPosition);

  /* ----- ORQUESTA FINAL ----- */

  function updateUI() {
    updateCarouselClasses();
    updateDots();
    updateTrackPosition();
    updateHero();
    renderProductList();
  }

  // inicializaciÃ³n
  applyBackendPrices();   // usa defaults primero
  createSlides();
  updateUI();
  updateCartRow();
  loadPricesFromSheet();  // luego intenta traer precios reales del Sheet
</script>
</body>
</html>

