<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>4:55 Monte Alto ‚Äì Calculadora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      /* PALETA CLARA (modo claro) */
      --bg-main: #f5f0e8;
      --bg-card: rgba(255, 254, 250, 0.96);
      --bg-dark: #141417;

      --accent: #4caf50;          /* verde Monte Alto (cajas, botones secundarios) */
      --accent-hover: #66bb6a;

      --accent-cta: #f4ff3b;      /* amarillo original para CTA (enviar / repetir) */

      --text-main: #1b1b1f;
      --text-muted: #77757f;

      --pill-bg: #fff7e3;
      --danger: #ff4b4b;

      --radius-xl: 28px;
      --radius-lg: 20px;

      --shadow-soft: 0 16px 40px rgba(0, 0, 0, 0.16);

      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", sans-serif;
    }

    /* MODO OSCURO (DEFAULT) CON AZULES + VERDE MONTE ALTO */
    body.dark {
      --bg-main: #0a1a2a;
      --bg-card: #17202a;
      --bg-dark: #0f1419;

      --text-main: #f2f2f2;
      --text-muted: #a0aec0;

      --pill-bg: #1d3557;
      --danger: #ff7676;

      --shadow-soft: 0 16px 40px rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background: var(--bg-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      color: var(--text-main);
    }

    .app {
      width: 100%;
      max-width: 980px;
      margin: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }

    .top-row {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (min-width: 840px) {
      .top-row {
        flex-direction: row;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 16px 18px 18px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    header.app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-name {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    .brand-sub {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* Bot√≥n peque√±o modo claro/oscuro (esquina superior derecha) */
    .mode-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.18);
      color: #ffd54f;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      font-size: 17px;
    }

    body:not(.dark) .mode-btn {
      background: rgba(255,255,255,0.9);
      color: #ffb300;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    h1 {
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-bottom: 6px;
    }

    .hero-main-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .hero-subline {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .hero-layout {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 16px;
      align-items: center;
    }

    @media (max-width: 720px) {
      .hero-layout {
        grid-template-columns: 1fr;
      }
    }

    .hero-image-wrap {
      display: flex;
      justify-content: center;
      position: relative;
      touch-action: pan-y;
    }

    .hero-plate {
      width: 260px;
      height: 170px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #2c3e50 0, #1b263b 60%, #111827 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 18px 40px rgba(0,0,0,0.65);
      overflow: hidden;
    }

    body:not(.dark) .hero-plate {
      background: radial-gradient(circle at top, #f6e1c8 0, #d9a66b 60%, #b6793e 100%);
    }

    .hero-plate img {
      width: 115%;
      height: auto;
      object-fit: cover;
    }

    .hero-tag {
      position: absolute;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--pill-bg);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #fefefe;
      box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    }

    body:not(.dark) .hero-tag {
      color: #6a4a1e;
      box-shadow: 0 6px 15px rgba(0,0,0,0.12);
    }

    .hero-tag span.icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #4caf50;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .tag-left { left: 10px; top: 22px; }
    .tag-right { right: 10px; bottom: 10px; }

    .hero-text-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .hero-product-name {
      font-size: 20px;
      font-weight: 700;
    }

    .hero-price-line {
      font-size: 14px;
      font-weight: 600;
      color: #ffca28;
    }

    body:not(.dark) .hero-price-line {
      color: #d88d17;
    }

    .hero-tagline {
      font-size: 13px;
      color: var(--text-muted);
    }

    .hero-meta-row {
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.14);
      color: #e0e6ed;
    }

    body:not(.dark) .pill {
      background: rgba(0,0,0,0.05);
      color: #4e4b54;
    }

    .stock-warning {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
    }

    /* Carrusel nav */
    .hero-carousel-nav {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .hero-nav-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      background: rgba(0,0,0,0.35);
      color: #fefefe;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    body:not(.dark) .hero-nav-btn {
      background: rgba(255,255,255,0.95);
      color: #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .hero-dots {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .hero-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #455a64;
      transition: transform 0.18s ease, background 0.18s ease;
    }

    .hero-dot.active {
      background: #ffca28;
      transform: scale(1.5);
    }

    .form-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .field-group {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 12px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #34495e;
      font-size: 13px;
      font-family: var(--font-main);
      outline: none;
      background: #0f1419;
      color: #f2f2f2;
    }

    body:not(.dark) input[type="text"],
    body:not(.dark) input[type="number"],
    body:not(.dark) select,
    body:not(.dark) textarea {
      background: #fffdf8;
      border-color: #ddd2c3;
      color: #1b1b1f;
    }

    textarea {
      min-height: 48px;
      resize: vertical;
    }

    small.helper {
      font-size: 11px;
      color: var(--text-muted);
    }

    .inline-row {
      display: flex;
      gap: 10px;
    }

    .inline-row > .field-group {
      flex: 1;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .checkbox-inline input {
      width: auto;
    }

    .points-banner {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #1b2838;
      color: #e3f2fd;
      margin-bottom: 8px;
      display: none;
    }

    body:not(.dark) .points-banner {
      background: rgba(255, 247, 220, 0.9);
      color: #5c4713;
    }

    .points-banner strong {
      font-weight: 700;
    }

    .last-order-banner {
      display: none;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #1b2838;
      color: #e3f2fd;
      font-size: 12px;
    }

    body:not(.dark) .last-order-banner {
      background: #fff3cd;
      color: #856404;
    }

    .last-order-banner button {
      margin-left: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      background: var(--accent-cta);
      cursor: pointer;
      font-size: 11px;
      color: #0a1a2a;
      font-weight: 600;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--accent);
      color: #0a1a2a;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      justify-content: center;
      padding: 10px 16px;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-cta {
      background: var(--accent-cta);
      color: #111;
      box-shadow: 0 8px 24px rgba(0,0,0,0.65);
      justify-content: center;
      padding: 12px 18px;
      font-size: 15px;
      transition: transform 0.1s ease;
    }

    .btn-cta:active {
      transform: scale(0.97);
    }

    .btn-secondary {
      background: #1b2838;
      color: #e0e6ed;
      border: 1px solid #34495e;
    }

    body:not(.dark) .btn-secondary {
      background: #ffffff;
      color: #333;
      border-color: #ddd;
    }

    .btn-hero-add {
      margin-top: 10px;
      align-self: flex-start;
      font-size: 13px;
      padding: 8px 13px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
    }

    .btn span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #0a1a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-size: 14px;
    }

    body:not(.dark) .btn span.icon {
      background: #111;
    }

    .btn-block {
      width: 100%;
      justify-content: center;
    }

    /* Picante naranja cuando valor = "si" */
    .picante-hot {
      border-color: #ff9800 !important;
      background: rgba(255, 152, 0, 0.1) !important;
      color: #ffcc80 !important;
    }

    body:not(.dark) .picante-hot {
      background: #fff3e0 !important;
      color: #e65100 !important;
    }

    hr.separator {
      border: none;
      border-top: 1px solid #1b2838;
      margin: 12px 0 10px;
    }

    body:not(.dark) hr.separator {
      border-top-color: rgba(0,0,0,0.06);
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 8px;
      font-size: 13px;
    }

    .totals-row strong {
      font-size: 16px;
    }

    .totals-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .footer-note {
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-muted);
    }

    /* Carrito como drawer lateral */
    .cart-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin-top: 4px;
      margin-bottom: 4px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .cart-icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: #1b2838;
      color: #e0e6ed;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      font-size: 16px;
    }

    body:not(.dark) .cart-icon-btn {
      background: #ffffff;
      color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.16);
    }

    .cart-count-badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(0,0,0,0.25);
      color: #e0e6ed;
    }

    body:not(.dark) .cart-count-badge {
      background: rgba(0,0,0,0.06);
      color: #444;
    }

    .cart-drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: flex-end;
      z-index: 40;
    }

    .cart-drawer-overlay.open {
      display: flex;
    }

    .cart-drawer {
      width: 88%;
      max-width: 360px;
      background: var(--bg-card);
      height: 100%;
      box-shadow: -6px 0 20px rgba(0,0,0,0.7);
      transform: translateX(100%);
      transition: transform 0.22s ease-out;
      display: flex;
      flex-direction: column;
      padding: 14px 14px 16px;
    }

    .cart-drawer.open {
      transform: translateX(0);
    }

    .cart-drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .cart-drawer-header h3 {
      font-size: 15px;
    }

    .cart-close-btn {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .cart-empty {
      font-size: 12px;
      color: var(--text-muted);
      padding: 6px 0;
    }

    .cart-table {
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #2c3e50;
      font-size: 12px;
      margin-top: 4px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    body:not(.dark) .cart-table {
      border-color: rgba(0,0,0,0.06);
    }

    .cart-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .cart-table th,
    .cart-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #1b2838;
    }

    body:not(.dark) .cart-table th,
    body:not(.dark) .cart-table td {
      border-bottom-color: rgba(0,0,0,0.04);
    }

    .cart-table th {
      background: #1b2838;
      text-align: left;
    }

    body:not(.dark) .cart-table th {
      background: rgba(0,0,0,0.03);
    }

    .cart-drawer-footer {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Confetti */
    .confetti-piece {
      position: fixed;
      width: 8px;
      height: 12px;
      border-radius: 2px;
      pointer-events: none;
      z-index: 999;
      animation: confetti-fall 900ms ease-out forwards;
    }

    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translate3d(0, 0, 0) rotateZ(0deg);
      }
      100% {
        opacity: 0;
        transform: translate3d(var(--dx), 60px, 0) rotateZ(260deg);
      }
    }
  </style>
</head>
<body class="dark">
<div class="app">

  <!-- HERO / PRODUCTO DESTACADO -->
  <div class="card hero">
    <header class="app-header">
      <div class="brand-block">
        <div class="brand-name">MONTE ALTO</div>
        <div class="brand-sub">CHARCUTER√çA ARTESANAL</div>
      </div>
      <button class="mode-btn" id="modeToggle" aria-label="Cambiar tema">
        üåô
      </button>
    </header>

    <h1>MONTE ALTO ‚Äì CALCULADORA</h1>
    <div class="hero-main-title">Seleccion√° tu chorizo</div>
    <div class="hero-subline">
      Eleg√≠ producto, gramaje y picante. Calculamos el total y los puntos.
    </div>

    <div class="hero-layout">
      <!-- Imagen / hero (ahora carrusel) -->
      <div class="hero-image-wrap" id="heroImageWrap">
        <div class="hero-plate">
          <img id="heroImage"
               src="Tex-Mex.png"
               alt="Producto Monte Alto">
        </div>

        <div class="hero-tag tag-left" id="heroTagLeft">
          <span class="icon">‚òÖ</span>
          <span>Favorito de la casa</span>
        </div>

        <div class="hero-tag tag-right" id="heroTagRight">
          <span class="icon">üå∂</span>
          <span>Picante medio</span>
        </div>
      </div>

      <!-- Texto producto -->
      <div class="hero-text-block">
        <div class="hero-product-name" id="heroProductName">Tex-Mex</div>
        <div class="hero-price-line" id="heroPrice">‚Ç°0 / kg</div>
        <div class="hero-tagline" id="productTagline">
          Molienda fresca con especias tostadas y un toque ahumado.
        </div>

        <div class="hero-meta-row">
          <span class="pill" id="heroYield">Rinde aprox. 3‚Äì4 porciones</span>
          <span class="pill" id="heroBaseGram">Sugerido: 500 g</span>
          <span class="pill" id="heroPoints">1 punto cada ‚Ç°100</span>
        </div>

        <div class="stock-warning" id="stockWarning" style="display:none;">
          Solo quedan X paquetes hoy.
        </div>

        <!-- Bot√≥n de agregar cerca de la imagen (quick add) -->
        <button class="btn btn-primary btn-hero-add" type="button" id="heroAddBtn">
          <span class="icon">Ôºã</span>
          Agregar al carrito
        </button>
      </div>
    </div>

    <!-- NAV DEL CARRUSEL -->
    <div class="hero-carousel-nav">
      <button class="hero-nav-btn" type="button" id="heroPrevBtn" aria-label="Producto anterior">‚Äπ</button>
      <div class="hero-dots" id="heroDots"></div>
      <button class="hero-nav-btn" type="button" id="heroNextBtn" aria-label="Producto siguiente">‚Ä∫</button>
    </div>
  </div>

  <div class="top-row">
    <!-- Formulario + carrito -->
    <div class="card form-cart">
      <!-- SECCI√ìN PEDIDO -->
      <div class="form-section-title">Pedido</div>

      <div class="field-group">
        <label for="productoSelect">Producto</label>
        <select id="productoSelect"></select>
      </div>

      <div class="inline-row">
        <div class="field-group">
          <label for="gramosInput">Gramos</label>
          <input type="number" id="gramosInput" min="500" step="500" placeholder="">
          <small class="helper">Se recomienda m√∫ltiplos de 500 g.</small>
        </div>
        <div class="field-group">
          <label for="picanteSelect">Picante</label>
          <select id="picanteSelect">
            <option value="">Seleccion√°...</option>
            <option value="no">No picante</option>
            <option value="si">Picante</option>
          </select>
        </div>
      </div>

      <div class="field-group">
        <label for="comentariosInput">Notas / comentarios</label>
        <textarea id="comentariosInput"
                  placeholder="Ej: cortar en rodajas, separar en paquetes, entrega urgente, etc."></textarea>
      </div>

      <!-- Bot√≥n agregar al carrito (despu√©s de notas) -->
      <div class="field-group">
        <button class="btn btn-primary btn-block" type="button" id="addToCartBtn">
          <span class="icon">Ôºã</span>
          Agregar al carrito
        </button>
      </div>

      <!-- Barra de carrito + drawer -->
      <div class="cart-bar" id="cartBar">
        <span>Ver carrito</span>
        <span class="cart-count-badge" id="cartCountBadge">0 √≠tems</span>
        <button class="cart-icon-btn" type="button" id="cartIconBtn">üõí</button>
      </div>

      <div class="totals-row">
        <div>
          Total estimado:<br>
          <span class="totals-sub">Incluye todos los productos del carrito.</span>
        </div>
        <div>
          <strong id="totalDisplay">‚Ç°0</strong><br>
          <span class="totals-sub">Puntos: <span id="pointsDisplay">0</span></span>
        </div>
      </div>

      <div class="footer-note">
        Tus descuentos NO reducen los puntos que gan√°s. Tus puntos siempre se calculan con el total original.
      </div>

      <hr class="separator">

      <!-- SECCI√ìN DATOS DEL CLIENTE -->
      <div class="form-section-title">Datos del cliente</div>

      <div class="field-group">
        <label for="telefonoInput">Tel√©fono (WhatsApp)</label>
        <input type="text" id="telefonoInput" placeholder="">
        <small class="helper">
          Usamos este n√∫mero para tus puntos y para confirmar el pedido.
        </small>
        <label class="checkbox-inline">
          <input type="checkbox" id="rememberPhoneChk" checked>
          <span>Recordar mi n√∫mero en este dispositivo</span>
        </label>
      </div>

      <div class="field-group">
        <label for="nombreInput">Nombre</label>
        <input type="text" id="nombreInput" placeholder="Tu nombre">
      </div>

      <div class="last-order-banner" id="lastOrderBanner">
        <span id="lastOrderText"></span>
        <button type="button" id="repeatLastBtn">Repetir</button>
      </div>

      <div class="points-banner" id="pointsBanner">
        <span id="pointsBannerText"></span>
      </div>

      <div style="margin-top:10px;">
        <button class="btn btn-cta btn-block" type="button" id="enviarPedidoBtn">
          <span class="icon">üõí</span>
          Enviar pedido
        </button>
      </div>
    </div>
  </div>

  <!-- Drawer del carrito -->
  <div class="cart-drawer-overlay" id="cartDrawerOverlay">
    <div class="cart-drawer" id="cartDrawer">
      <div class="cart-drawer-header">
        <h3>Tu carrito</h3>
        <button class="cart-close-btn" type="button" id="cartCloseBtn">‚úï</button>
      </div>

      <div id="cartEmptyMsg" class="cart-empty">A√∫n no has agregado productos.</div>

      <div class="cart-table" id="cartTableWrapper" style="display:none;">
        <table>
          <thead>
          <tr>
            <th>Producto</th>
            <th>Gramos</th>
            <th>Picante</th>
            <th>Total</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="cartTableBody"></tbody>
        </table>
      </div>

      <div class="cart-drawer-footer">
        Revis√° tu pedido antes de enviarlo. Pod√©s cerrar esta ventana para seguir editando.
      </div>
    </div>
  </div>
</div>

<script>
  // =============================
  // CONFIGURACI√ìN
  // =============================
  const APPS_SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbw6r1oogKYA6uD5o0Eh7wkHE-idcreykcD7n4cTIn0OoXriF5219WOQVveAMAKJQEKZ/exec";

  const CONFIG = {
    colonesPorPunto: 100,
    productos: {
      texmex: {
        id: "texmex",
        nombre: "Tex-Mex",
        precioKg: 8500,
        tagline: "Molienda fresca con especias tostadas y un toque ahumado.",
        stockPaquetesHoy: 6,
        upsellSugeridoId: "criollo",
        rinde: "Rinde aprox. 3‚Äì4 porciones",
        imagen: "Tex-Mex.png",
        picanteNivel: "Picante medio"
      },
      caribeno: {
        id: "caribeno",
        nombre: "Caribe√±o",
        precioKg: 8700,
        tagline: "Ajo fresco, coco natural y chile paname√±o costero.",
        stockPaquetesHoy: 5,
        upsellSugeridoId: null,
        rinde: "Ideal para 3‚Äì4 platos",
        imagen: "Caribeno.png",
        picanteNivel: "Suave y arom√°tico"
      },
      criollo: {
        id: "criollo",
        nombre: "Criollo Argentino",
        precioKg: 8300,
        tagline: "Receta cl√°sica con mezcla de posta y panceta.",
        stockPaquetesHoy: 4,
        upsellSugeridoId: null,
        rinde: "Perfecto para la parrilla",
        imagen: "Argentino.png",
        picanteNivel: "Cl√°sico, no picante"
      },
      bratwurst: {
        id: "bratwurst",
        nombre: "Bratwurst",
        precioKg: 8900,
        tagline: "Suave, jugoso, estilo alem√°n.",
        stockPaquetesHoy: 3,
        upsellSugeridoId: null,
        rinde: "Ideal para panes",
        imagen: "Bratwurst.png",
        picanteNivel: "Suave"
      },
      bacon: {
        id: "bacon",
        nombre: "Bacon ahumado",
        precioKg: 10000,
        tagline: "Tocineta ahumada lentamente, corte grueso.",
        stockPaquetesHoy: 5,
        upsellSugeridoId: null,
        rinde: "Acompa√±a 3‚Äì4 recetas",
        imagen: "Bacon.png",
        picanteNivel: "No picante"
      },
      comboSurtido: {
        id: "comboSurtido",
        nombre: "Combo surtido (500 g de cada chorizo)",
        precioKg: 0,
        precioFijo: 21000, // AJUSTAR A TU REALIDAD
        tagline: "Pack degustaci√≥n con 500 g de cada chorizo Monte Alto.",
        stockPaquetesHoy: 3,
        upsellSugeridoId: null,
        rinde: "2.5 kg totales (5 sabores)",
        imagen: "Combo.png",
        picanteNivel: "Degustaci√≥n completa",
        esCombo: true
      }
    }
  };

  // Orden del carrusel
  const HERO_ORDER = [
    "texmex",
    "caribeno",
    "criollo",
    "bratwurst",
    "bacon",
    "comboSurtido"
  ].filter(id => CONFIG.productos[id]); // por si alguno faltara

  // =============================
  // ESTADO
  // =============================
  let state = {
    telefono: "",
    nombre: "",
    puntos: 0,
    lastOrderSummary: null,
    lastOrderItems: null,
    lastLookupTel: ""
  };

  let cart = [];
  let currentHeroIndex = 0;

  // =============================
  // UTILIDADES
  // =============================
  function formatoColones(valor) {
    return "‚Ç°" + (valor || 0).toLocaleString("es-CR");
  }

  // Limpia el tel√©fono: deja solo d√≠gitos y se queda con los √öLTIMOS 8
  function normalizePhone(raw) {
    if (!raw) return "";
    const digitsOnly = raw.replace(/\D/g, "");
    if (!digitsOnly) return "";
    return digitsOnly.length > 8
      ? digitsOnly.slice(-8)
      : digitsOnly;
  }

  function calcularPrecioProducto(prod, gramos) {
    if (!prod) return 0;
    if (prod.esCombo && prod.precioFijo) {
      return prod.precioFijo;
    }
    const g = gramos || 0;
    return Math.round(prod.precioKg * (g / 1000));
  }

  function vibrar(ms = 80) {
    try {
      if (navigator.vibrate) navigator.vibrate(ms);
    } catch (e) {
      // no pasa nada si falla
    }
  }

  function lanzarConfettiDesdeElemento(el) {
    const rect = el.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top;

    const colores = ["#f4ff3b", "#ffb300", "#4caf50", "#ff7043", "#29b6f6"];
    const cantidad = 28;

    for (let i = 0; i < cantidad; i++) {
      const div = document.createElement("div");
      div.className = "confetti-piece";
      const color = colores[Math.floor(Math.random() * colores.length)];
      div.style.background = color;
      div.style.left = (x + (Math.random() * 80 - 40)) + "px";
      div.style.top = (y + (Math.random() * 10 - 5)) + "px";
      const dx = (Math.random() * 80 - 40) + "px";
      div.style.setProperty("--dx", dx);
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 950);
    }
  }

  // =============================
  // REFERENCIAS DOM
  // =============================
  const productoSelect = document.getElementById("productoSelect");
  const picanteSelect = document.getElementById("picanteSelect");
  const gramosInput = document.getElementById("gramosInput");

  const heroImage = document.getElementById("heroImage");
  const heroImageWrap = document.getElementById("heroImageWrap");
  const heroProductName = document.getElementById("heroProductName");
  const heroPrice = document.getElementById("heroPrice");
  const productTaglineEl = document.getElementById("productTagline");
  const heroYieldEl = document.getElementById("heroYield");
  const heroBaseGramEl = document.getElementById("heroBaseGram");
  const heroTagLeft = document.getElementById("heroTagLeft");
  const heroTagRight = document.getElementById("heroTagRight");
  const stockWarningEl = document.getElementById("stockWarning");

  const heroPrevBtn = document.getElementById("heroPrevBtn");
  const heroNextBtn = document.getElementById("heroNextBtn");
  const heroDotsEl = document.getElementById("heroDots");

  const totalDisplay = document.getElementById("totalDisplay");
  const pointsDisplay = document.getElementById("pointsDisplay");
  const pointsBanner = document.getElementById("pointsBanner");
  const pointsBannerText = document.getElementById("pointsBannerText");
  const lastOrderBanner = document.getElementById("lastOrderBanner");
  const lastOrderText = document.getElementById("lastOrderText");

  const telefonoInput = document.getElementById("telefonoInput");
  const nombreInput = document.getElementById("nombreInput");
  const rememberPhoneChk = document.getElementById("rememberPhoneChk");

  const cartDrawerOverlay = document.getElementById("cartDrawerOverlay");
  const cartDrawer = document.getElementById("cartDrawer");
  const cartTableWrapper = document.getElementById("cartTableWrapper");
  const cartTableBody = document.getElementById("cartTableBody");
  const cartEmptyMsg = document.getElementById("cartEmptyMsg");
  const cartCountBadge = document.getElementById("cartCountBadge");
  const cartIconBtn = document.getElementById("cartIconBtn");
  const cartBar = document.getElementById("cartBar");

  const modeToggle = document.getElementById("modeToggle");

  // =============================
  // PRODUCTOS / HERO + CARRUSEL
  // =============================
  function initProductos() {
    productoSelect.innerHTML = "";
    HERO_ORDER.forEach(id => {
      const prod = CONFIG.productos[id];
      if (!prod) return;
      const opt = document.createElement("option");
      opt.value = prod.id;
      opt.textContent = prod.nombre;
      productoSelect.appendChild(opt);
    });
    currentHeroIndex = 0;
    productoSelect.value = HERO_ORDER[0];
    onProductoChange();
    renderHeroDots();
  }

  function onProductoChange() {
    const prodId = productoSelect.value;
    const prod = CONFIG.productos[prodId];
    if (!prod) return;

    // actualizar √≠ndice del carrusel seg√∫n select
    const idx = HERO_ORDER.indexOf(prodId);
    if (idx >= 0) currentHeroIndex = idx;

    heroProductName.textContent = prod.nombre;
    heroImage.src = prod.imagen;
    heroImage.alt = prod.nombre;

    if (prod.esCombo) {
      heroPrice.textContent = prod.precioFijo
        ? formatoColones(prod.precioFijo) + " combo"
        : "Precio combo";
      heroBaseGramEl.textContent = "2.5 kg totales";
      gramosInput.value = 2500;
      gramosInput.disabled = true;
    } else {
      heroPrice.textContent = formatoColones(prod.precioKg) + " / kg";
      heroBaseGramEl.textContent = "Sugerido: 500 g";
      gramosInput.disabled = false;
      if (!gramosInput.value) gramosInput.value = 500;
    }

    productTaglineEl.textContent = prod.tagline || "";
    heroYieldEl.textContent = prod.rinde || "";

    heroTagLeft.querySelector("span.icon").textContent = "‚òÖ";
    heroTagLeft.querySelector("span:last-child").textContent =
      prod.esCombo ? "Pack degustaci√≥n" : "Favorito de la casa";

    heroTagRight.querySelector("span.icon").textContent = "üå∂";
    heroTagRight.querySelector("span:last-child").textContent =
      prod.picanteNivel || "Intensidad";

    if (typeof prod.stockPaquetesHoy === "number" && prod.stockPaquetesHoy > 0) {
      if (prod.stockPaquetesHoy <= 4) {
        stockWarningEl.textContent =
          `Solo quedan ${prod.stockPaquetesHoy} paquetes hoy.`;
        stockWarningEl.style.display = "block";
      } else {
        stockWarningEl.style.display = "none";
      }
    } else {
      stockWarningEl.style.display = "none";
    }

    renderHeroDots();
  }

  productoSelect.addEventListener("change", onProductoChange);

  function renderHeroDots() {
    heroDotsEl.innerHTML = "";
    HERO_ORDER.forEach((id, index) => {
      const dot = document.createElement("div");
      dot.className = "hero-dot" + (index === currentHeroIndex ? " active" : "");
      dot.addEventListener("click", () => {
        heroShowIndex(index);
      });
      heroDotsEl.appendChild(dot);
    });
  }

  function heroShowIndex(index) {
    const len = HERO_ORDER.length;
    if (!len) return;
    currentHeroIndex = (index + len) % len;
    const prodId = HERO_ORDER[currentHeroIndex];
    productoSelect.value = prodId;
    onProductoChange();
  }

  document.getElementById("heroPrevBtn").addEventListener("click", () => {
    heroShowIndex(currentHeroIndex - 1);
  });

  document.getElementById("heroNextBtn").addEventListener("click", () => {
    heroShowIndex(currentHeroIndex + 1);
  });

  // Swipe en la imagen
  let touchStartX = null;
  heroImageWrap.addEventListener("touchstart", (e) => {
    if (!e.touches || !e.touches.length) return;
    touchStartX = e.touches[0].clientX;
  }, { passive: true });

  heroImageWrap.addEventListener("touchend", (e) => {
    if (touchStartX == null) return;
    const touchEndX = e.changedTouches && e.changedTouches[0]
      ? e.changedTouches[0].clientX
      : touchStartX;
    const deltaX = touchEndX - touchStartX;
    const threshold = 40; // px
    if (Math.abs(deltaX) > threshold) {
      if (deltaX < 0) {
        heroShowIndex(currentHeroIndex + 1); // swipe izquierda -> siguiente
      } else {
        heroShowIndex(currentHeroIndex - 1); // swipe derecha -> anterior
      }
    }
    touchStartX = null;
  });

  // =============================
  // CARRITO
  // =============================
  function addToCart() {
    const prodId = productoSelect.value;
    const prod = CONFIG.productos[prodId];
    if (!prod) return;

    let gramos = parseInt(gramosInput.value, 10) || 0;
    if (prod.esCombo) gramos = 2500;

    if (gramos <= 0) {
      alert("Indic√° los gramos que necesit√°s (m√∫ltiplos de 500 g).");
      return;
    }

    const picante = picanteSelect.value; // "si" / "no" / ""

    const total = calcularPrecioProducto(prod, gramos);

    cart.push({
      productoId: prodId,
      nombre: prod.nombre,
      gramos,
      picante,
      total
    });

    renderCart();

    if (!prod.esCombo) gramosInput.value = 500;
    picanteSelect.value = "";
    picanteSelect.classList.remove("picante-hot");

    mostrarUpsell(prodId);
  }

  function mostrarUpsell(prodId) {
    const prod = CONFIG.productos[prodId];
    if (!prod || !prod.upsellSugeridoId) return;

    const sugerido = CONFIG.productos[prod.upsellSugeridoId];
    if (!sugerido) return;

    const msg =
      `Sugerencia Monte Alto:\n\n` +
      `Las personas que compran ${prod.nombre} tambi√©n suelen llevar ${sugerido.nombre}.\n\n` +
      `¬øQuer√©s agregarlo tambi√©n?`;

    if (confirm(msg)) {
      agregarProductoDirecto(sugerido.id, 500);
    }
  }

  function agregarProductoDirecto(prodId, gramos) {
    const prod = CONFIG.productos[prodId];
    if (!prod) return;

    const total = calcularPrecioProducto(prod, gramos);
    cart.push({
      productoId: prodId,
      nombre: prod.nombre,
      gramos,
      picante: "",
      total
    });
    renderCart();
  }

  function eliminarDelCart(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function renderCart() {
    const cantidad = cart.length;
    cartCountBadge.textContent = cantidad + (cantidad === 1 ? " √≠tem" : " √≠tems");

    if (!cantidad) {
      cartEmptyMsg.style.display = "block";
      cartTableWrapper.style.display = "none";
    } else {
      cartEmptyMsg.style.display = "none";
      cartTableWrapper.style.display = "block";
    }

    cartTableBody.innerHTML = "";
    let total = 0;

    cart.forEach((item, idx) => {
      total += item.total || 0;
      const tr = document.createElement("tr");

      const tdProd = document.createElement("td");
      tdProd.textContent = item.nombre;

      const tdGram = document.createElement("td");
      tdGram.textContent = item.gramos + " g";

      const tdPic = document.createElement("td");
      tdPic.textContent =
        item.picante === "si" ? "Picante" :
        item.picante === "no" ? "No picante" : "-";

      const tdTot = document.createElement("td");
      tdTot.textContent = formatoColones(item.total);

      const tdDel = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.textContent = "‚úï";
      btnDel.className = "btn btn-secondary";
      btnDel.style.padding = "3px 8px";
      btnDel.style.fontSize = "11px";
      btnDel.addEventListener("click", () => eliminarDelCart(idx));
      tdDel.appendChild(btnDel);

      tr.appendChild(tdProd);
      tr.appendChild(tdGram);
      tr.appendChild(tdPic);
      tr.appendChild(tdTot);
      tr.appendChild(tdDel);

      cartTableBody.appendChild(tr);
    });

    totalDisplay.textContent = formatoColones(total);

    const puntos = Math.floor(total / CONFIG.colonesPorPunto);
    pointsDisplay.textContent = puntos;
  }

  document.getElementById("addToCartBtn").addEventListener("click", () => {
    addToCart();
  });

  document.getElementById("heroAddBtn").addEventListener("click", () => {
    addToCart();
  });

  // Drawer open/close
  function abrirDrawer() {
    cartDrawerOverlay.classList.add("open");
    cartDrawer.classList.add("open");
  }

  function cerrarDrawer() {
    cartDrawer.classList.remove("open");
    setTimeout(() => cartDrawerOverlay.classList.remove("open"), 200);
  }

  cartIconBtn.addEventListener("click", abrirDrawer);
  cartBar.addEventListener("click", (e) => {
    if (e.target === cartIconBtn) return;
    abrirDrawer();
  });

  document.getElementById("cartCloseBtn").addEventListener("click", cerrarDrawer);
  cartDrawerOverlay.addEventListener("click", (e) => {
    if (e.target === cartDrawerOverlay) cerrarDrawer();
  });

  // =============================
  // PUNTOS / CLIENTE
  // =============================
  function hacerLookupCliente(telNormalizado) {
    if (!telNormalizado || telNormalizado.length !== 8) return;

    if (state.lastLookupTel === telNormalizado) return;
    state.lastLookupTel = telNormalizado;
    state.telefono = telNormalizado;
    state.nombre = nombreInput.value.trim() || "";

    // Guardar en localStorage si el usuario quiere
    if (rememberPhoneChk.checked) {
      try {
        localStorage.setItem("ma_phone", telNormalizado);
      } catch (e) {
        console.warn("No se pudo guardar el tel√©fono en localStorage:", e);
      }
    }

    // Aqu√≠ deber√≠a ir el fetch real a APPS_SCRIPT_URL.
    // Por ahora, simulamos:
    simularConsultaCliente(telNormalizado);
  }

  function simularConsultaCliente(tel) {
    if (tel.endsWith("22")) {
      state.puntos = 250;
      state.lastOrderSummary = "Tex-Mex 1000 g + Caribe√±o 500 g";
      state.lastOrderItems = [
        { productoId: "texmex", nombre: "Tex-Mex", gramos: 1000, picante: "si", total: 8500 },
        { productoId: "caribeno", nombre: "Caribe√±o", gramos: 500, picante: "no", total: 4350 }
      ];
    } else {
      state.puntos = 0;
      state.lastOrderSummary = null;
      state.lastOrderItems = null;
    }

    renderPuntos();
    renderLastOrderBanner();
  }

  function renderPuntos() {
    if (state.puntos > 0) {
      pointsBannerText.innerHTML =
        `Ten√©s <strong>${state.puntos} puntos</strong> acumulados. ` +
        `1 punto por cada ‚Ç°${CONFIG.colonesPorPunto.toLocaleString("es-CR")}.`;
      pointsBanner.style.display = "block";
    } else {
      pointsBannerText.textContent =
        "Esta puede ser tu primera compra con puntos Monte Alto. ¬°Bienvenido!";
      pointsBanner.style.display = "block";
    }
  }

  function renderLastOrderBanner() {
    if (!state.lastOrderSummary) {
      lastOrderBanner.style.display = "none";
      return;
    }
    lastOrderText.textContent =
      `La √∫ltima vez compraste ${state.lastOrderSummary}. ¬øQuer√©s repetir algo similar?`;
    lastOrderBanner.style.display = "flex";
  }

  document.getElementById("repeatLastBtn").addEventListener("click", (e) => {
    if (!state.lastOrderItems || !Array.isArray(state.lastOrderItems)) return;
    cart = state.lastOrderItems.map(item => ({ ...item }));
    renderCart();
    vibrar(90);
    lanzarConfettiDesdeElemento(e.currentTarget);
    alert("Listo, cargamos un pedido similar al de la vez pasada. Pod√©s ajustarlo antes de enviar.");
  });

  // Auto-normalizar tel√©fono y disparar lookup cuando llegue a 8 d√≠gitos
  telefonoInput.addEventListener("input", () => {
    const before = telefonoInput.value;
    const norm = normalizePhone(before);
    if (before !== norm) {
      telefonoInput.value = norm;
    }
    if (norm.length === 8) {
      hacerLookupCliente(norm);
    }
  });

  // =============================
  // ENVIAR PEDIDO
  // =============================
  document.getElementById("enviarPedidoBtn").addEventListener("click", (e) => {
    if (!cart.length) {
      alert("Agreg√° al menos un producto al carrito antes de enviar.");
      return;
    }

    const telNorm = normalizePhone(telefonoInput.value);
    telefonoInput.value = telNorm;

    const tel = telNorm;
    const nom = nombreInput.value.trim();
    if (!tel || tel.length !== 8 || !nom) {
      alert("Indic√° tu tel√©fono (8 d√≠gitos) y tu nombre antes de enviar el pedido.");
      return;
    }

    const comentarios = document.getElementById("comentariosInput").value.trim();
    const total = cart.reduce((acc, item) => acc + (item.total || 0), 0);
    const puntosGanados = Math.floor(total / CONFIG.colonesPorPunto);

    const resumenLineas = cart.map(item => {
      const pic =
        item.picante === "si" ? " (picante)" :
        item.picante === "no" ? " (no picante)" : "";
      return `‚Ä¢ ${item.nombre} ‚Äì ${item.gramos} g${pic}: ${formatoColones(item.total)}`;
    }).join("\n");

    const mensaje =
      `Pedido Monte Alto ‚Äì ${nom} (${tel})\n\n` +
      `${resumenLineas}\n\n` +
      `Total: ${formatoColones(total)}\n` +
      `Puntos por esta compra: ${puntosGanados}\n\n` +
      (comentarios ? `Notas del cliente:\n${comentarios}\n\n` : "") +
      `Tus descuentos NO reducen tus puntos acumulados.`;

    console.log("Mensaje de pedido:", mensaje);

    vibrar(100);
    lanzarConfettiDesdeElemento(e.currentTarget);

    // TODO: reemplazar alerta por fetch + WhatsApp como en la calculadora live
    alert("Simulaci√≥n de env√≠o:\n\n" + mensaje);
  });

  // =============================
  // MODO CLARO/OSCURO
  // =============================
  function aplicarTema(desired) {
    const tema = desired || localStorage.getItem("ma_theme") || "dark";
    if (tema === "dark") {
      document.body.classList.add("dark");
      modeToggle.textContent = "üåô";
    } else {
      document.body.classList.remove("dark");
      modeToggle.textContent = "‚òÄ";
    }
    try {
      localStorage.setItem("ma_theme", tema);
    } catch (e) {
      console.warn("No se pudo guardar el tema en localStorage:", e);
    }
  }

  modeToggle.addEventListener("click", () => {
    const esDark = document.body.classList.contains("dark");
    aplicarTema(esDark ? "light" : "dark");
  });

  // Picante select estilo naranja cuando es picante
  picanteSelect.addEventListener("change", () => {
    if (picanteSelect.value === "si") {
      picanteSelect.classList.add("picante-hot");
    } else {
      picanteSelect.classList.remove("picante-hot");
    }
  });

  // =============================
  // INIT
  // =============================
  window.addEventListener("DOMContentLoaded", () => {
    initProductos();
    aplicarTema("dark"); // default: oscuro

    // Intentar cargar tel√©fono recordado
    try {
      const savedTel = localStorage.getItem("ma_phone");
      if (savedTel && savedTel.length === 8) {
        telefonoInput.value = savedTel;
        hacerLookupCliente(savedTel);
      }
    } catch (e) {
      console.warn("No se pudo leer ma_phone de localStorage:", e);
    }
  });
</script>

</body>
</html>
